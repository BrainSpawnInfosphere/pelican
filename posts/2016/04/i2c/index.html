<!-- This is for the actual single article -->


<!DOCTYPE html>
<html lang="en">
<head>
  <title>I2C | Planet Express</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<meta name="description" content="Simple Python I2C example"><meta name="author" content="walchko">  <meta name="viewport" content="initial-scale=1, maximum-scale=1" />
  <meta http-equiv="Cache-Control" content="max-age=604800, must-revalidate" />
  <link href="../../../../theme/css/screen.css" rel="stylesheet" type="text/css" />
  <link href="../../../../theme/css/pygments.css" rel="stylesheet" type="text/css" />
  <link rel="icon" href="../../../../favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="../../../../favicon.ico" type="image/x-icon">
</head>
<body>
<div id="outer-wrapper">
<div id="header-wrapper">
  <div class="logo"><a href="../../../..">Planet Express</a></div>
  <div class="small">Our crew is replaceable. Your package isn't.</div>
  <div class="nav">
  <li><a href="../../../../about.html">About Me</a></li>
  <li><a href="../../../../colophon.html">Colophon</a></li>
  <li><a href="../../../../categories.html">Topics</a></li>
  <li><a href="../../../../archives.html">Blog</a></li>
  </div>
  <div class="nav social">
<ul>
    <li><a href="http://github.com/walchko"><i class="fa fa-github-alt fa-2x"></i></a></li>
    <li><a href="http://stackoverflow.com/users/5374768/kevin"><i class="fa fa-stack-overflow fa-2x"></i></a></li>
    <li><a href="http://raspberrypi.stackexchange.com/users/1677/kevin"><i class="fa fa-stack-exchange fa-2x"></i></a></li>
</ul>  </div>
</div>    <div id="main">

<!--  -->

<h2><a href="../../../../posts/2016/04/i2c">I2C</a></h2>
<h5><i class="icon-feather"></i> Thu 21 April 2016
<i class="icon-bookmarks"></i>
</h5>

<p>I2C (Inter-Integrated Circuit), pronounced I-squared-C, is a multi-master, multi-slave,
single-ended, serial computer bus invented by Philips Semiconductor (now NXP
Semiconductors). It is typically used for attaching lower-speed peripheral ICs to
processors and microcontrollers in short-distance, intra-board communication. Alternatively
I2C is spelled I2C (pronounced I-two-C) or IIC (pronounced I-I-C).</p>
<p>Addressing is based of a 7-bit addressing system, where each data packet looks like:</p>
<div class="figure align-center">
<img alt="" src="../../../../blog/programming/pics/7-bit-address-i2c.png" style="width: 600px;" />
</div>
<p>If you have everything setup correctly, you should be able to see what is on your i2c bus
by typing:</p>
<div class="highlight"><pre><span></span>[kevin@raspberrypi ~]$ sudo i2cdetect -y 1
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- --
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
20: 20 -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
70: -- -- -- -- -- -- -- --
</pre></div>
<p>Note that something is attached to the <tt class="docutils literal">0x20</tt> address.</p>
<div class="section" id="python-scripts">
<h2>Python Scripts</h2>
<pre class="literal-block">
pip install Adafruit_GPIO
</pre>
<p>Then a simple program might look like:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">Adafruit_GPIO</span> <span class="kn">as</span> <span class="nn">GPIO</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">MCP23017</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span> <span class="c1"># set all pins to output</span>
    <span class="n">pins</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span> <span class="c1"># set pins 1&amp;5 True and pin 3 False</span>
    <span class="n">io</span><span class="o">.</span><span class="n">output_pins</span><span class="p">(</span><span class="n">pins</span><span class="p">)</span>
</pre></div>
<p>smbus-cffi</p>
<pre class="literal-block">
sudo apt-get install build-essential libi2c-dev i2c-tools python-dev libffi-dev
pip install smbus-cffi
</pre>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">smbus</span>
<span class="c1"># from Adafruit import smbus</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1">#bus = smbus.SMBus(0)  # Rev 1 Pi uses 0</span>
<span class="n">bus</span> <span class="o">=</span> <span class="n">smbus</span><span class="o">.</span><span class="n">SMBus</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Rev 2 Pi uses 1</span>

<span class="n">DEVICE</span> <span class="o">=</span> <span class="mh">0x20</span> <span class="c1"># Device address (A0-A2)</span>
<span class="n">IODIRA</span> <span class="o">=</span> <span class="mh">0x00</span> <span class="c1"># Pin direction register</span>
<span class="n">OLATA</span>  <span class="o">=</span> <span class="mh">0x14</span> <span class="c1"># Register for outputs</span>
<span class="n">GPIOA</span>  <span class="o">=</span> <span class="mh">0x12</span> <span class="c1"># Register for inputs</span>

<span class="c1"># Set all GPA pins as outputs by setting</span>
<span class="c1"># all bits of IODIRA register to 0</span>
<span class="n">bus</span><span class="o">.</span><span class="n">write_byte_data</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">,</span><span class="n">IODIRA</span><span class="p">,</span><span class="mh">0x00</span><span class="p">)</span>

<span class="c1"># Set output all 7 output bits to 0</span>
<span class="n">bus</span><span class="o">.</span><span class="n">write_byte_data</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">,</span><span class="n">OLATA</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">MyData</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span>
  <span class="c1"># Count from 1 to 8 which in binary will count</span>
  <span class="c1"># from 001 to 111</span>
  <span class="n">bus</span><span class="o">.</span><span class="n">write_byte_data</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">,</span><span class="n">OLATA</span><span class="p">,</span><span class="n">MyData</span><span class="p">)</span>
  <span class="k">print</span> <span class="n">MyData</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Set all bits to zero</span>
<span class="n">bus</span><span class="o">.</span><span class="n">write_byte_data</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">,</span><span class="n">OLATA</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="c1"># from Adafruit import smbus</span>
<span class="kn">import</span> <span class="nn">smbus</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># bus = smbus.SMBus(0)  # Rev 1 Pi uses 0</span>
<span class="n">bus</span> <span class="o">=</span> <span class="n">smbus</span><span class="o">.</span><span class="n">SMBus</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Rev 2 Pi uses 1</span>

<span class="n">DEVICE</span> <span class="o">=</span> <span class="mh">0x20</span> <span class="c1"># Device address (A0-A2)</span>
<span class="n">IODIRA</span> <span class="o">=</span> <span class="mh">0x00</span> <span class="c1"># Pin direction register</span>
<span class="n">GPIOA</span>  <span class="o">=</span> <span class="mh">0x12</span> <span class="c1"># Register for inputs</span>

<span class="c1"># Set first 7 GPA pins as outputs and</span>
<span class="c1"># last one as input.</span>
<span class="n">bus</span><span class="o">.</span><span class="n">write_byte_data</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">,</span><span class="n">IODIRA</span><span class="p">,</span><span class="mh">0x80</span><span class="p">)</span>

<span class="c1"># Loop until user presses CTRL-C</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

  <span class="c1"># Read state of GPIOA register</span>
  <span class="n">MySwitch</span> <span class="o">=</span> <span class="n">bus</span><span class="o">.</span><span class="n">read_byte_data</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">,</span><span class="n">GPIOA</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">MySwitch</span> <span class="o">&amp;</span> <span class="mb">0b10000000</span> <span class="o">==</span> <span class="mb">0b10000000</span><span class="p">:</span>
          <span class="k">print</span> <span class="s2">&quot;Switch was pressed!&quot;</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
<p>Converting between binary data and int, float, etc can be done with standard python libraries.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">binascii</span>

<span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="s1">&#39;010f&#39;</span><span class="p">)</span>  <span class="c1"># &#39;\x01\x0f&#39;</span>
<span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;h&#39;</span><span class="p">,</span><span class="mh">0x010f</span><span class="p">)</span>  <span class="c1"># big endian &#39;\x01\x0f&#39;</span>
<span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;h&#39;</span><span class="p">,</span><span class="mh">0x010f</span><span class="p">)</span>  <span class="c1"># little endian &#39;\x0f\x01&#39;</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;h&#39;</span><span class="p">,</span><span class="mh">0x0101</span><span class="p">)</span>  <span class="c1"># &#39;\x0f\x01&#39;</span>
<span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;h&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>  <span class="c1"># (257,)</span>

<span class="c1"># little endian conversions</span>
<span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;h&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00\xef</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># (-4352,) signed short</span>
<span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;H&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00\xef</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># (61184,) unsigned short</span>
<span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;f&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x01\x01\xff\xaa</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># (-4.529779600460221e-13,) float</span>
</pre></div>
</div>
<div class="section" id="references">
<h2>References</h2>
<ul class="simple">
<li><a class="reference external" href="https://en.wikipedia.org/wiki/I%C2%B2C">wikipedia i2c</a></li>
<li><a class="reference external" href="https://docs.python.org/2/library/struct.html?highlight=struct#module-struct">struct python docs</a></li>
</ul>
</div>


<p align="center"><a href="#">on the top</a></p>
    </div>
</div>
<div id="footer-wrapper">
<ul class="footer">
</ul><ul class="footer">
    <li class="footer">&copy;&nbsp;2016&nbsp;Kevin J. Walchko&nbsp;::</li>
    <li class="footer"><a href="../../../..">Planet Express </a>&nbsp;::</li>
    <li class="footer"><a href="https://github.com/getpelican">pelican</a></li>
    <!-- <li class="footer"><a href="http://creativecommons.org/licenses/by-nc/3.0/deed">Content CC BY-NC</a>&nbsp;::</li> -->
    <!-- <li class="footer"><a href="http://fontawesome.io">Font Awesome <i class="fa fa-flag"></i></a></li> -->
    <!-- <li class="footer"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a></li> -->
</ul>
<span><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a></span>
</div></body>
</html>