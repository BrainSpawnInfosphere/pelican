<!-- This is for the actual single article -->


<!DOCTYPE html>
<html lang="en">
<head>
  <title>Quadruped Robot | Planet Express</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<meta name="description" content="Simple quadruped made from a 3d printed body and 9 gram micro servos (TG9e)."><meta name="author" content="walchko">  <meta name="viewport" content="initial-scale=1, maximum-scale=1" />
  <meta http-equiv="Cache-Control" content="max-age=604800, must-revalidate" />
  <link href="../../../../theme/css/screen.css" rel="stylesheet" type="text/css" />
  <link href="../../../../theme/css/pygments.css" rel="stylesheet" type="text/css" />
  <link rel="icon" href="../../../../favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="../../../../favicon.ico" type="image/x-icon">
</head>
<body>
<div id="outer-wrapper">
<div id="header-wrapper">
  <div class="logo"><a href="../../../..">Planet Express</a></div>
  <div class="small">Our crew is replaceable. Your package isn't.</div>
  <div class="nav">
  <li><a href="../../../../about.html">About Me</a></li>
  <li><a href="../../../../colophon.html">Colophon</a></li>
  <li><a href="../../../../categories.html">Topics</a></li>
  <li><a href="../../../../archives.html">Blog</a></li>
  </div>
  <div class="nav social">
<ul>
    <li><a href="http://github.com/walchko"><i class="fa fa-github-alt fa-2x"></i></a></li>
    <li><a href="http://stackoverflow.com/users/5374768/kevin"><i class="fa fa-stack-overflow fa-2x"></i></a></li>
    <li><a href="http://raspberrypi.stackexchange.com/users/1677/kevin"><i class="fa fa-stack-exchange fa-2x"></i></a></li>
</ul>  </div>
</div>    <div id="main">

<!--  -->

<h2><a href="../../../../posts/2016/07/quadruped-robot">Quadruped Robot</a></h2>
<h5><i class="icon-feather"></i> Mon 11 July 2016
<i class="icon-bookmarks"></i>
</h5>

<div class="figure align-center">
<img alt="" src="../../../../blog/robots/pics/rc-spider-1.jpg" style="width: 400px;" />
</div>
<div class="section" id="kinematics">
<h2>Kinematics</h2>
<div class="section" id="useful-trigonometry">
<h3>Useful Trigonometry</h3>
<div class="figure align-center">
<img alt="" src="../../../../blog/robots/pics/law_cosines.png" />
</div>
<p>The <strong>law of cosines</strong> for calculating one side of a triangle when the angle
opposite and the other two sides are known. Can be used in conjunction with
the law of sines to find all sides and angles.</p>
</div>
<div class="section" id="forward-kinematics">
<h3>Forward Kinematics</h3>
<p>Forward kinematics produces the position (x,y,z) of the foot given the angles
of the leg segment joints. We will use the following parameters (from the real
robot) and nomenclature</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="58%" />
<col width="22%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Leg Segment</th>
<th class="head">Symbol</th>
<th class="head">Length</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Coxa</td>
<td><span class="math">\(L_{coxa}\)</span> or <span class="math">\(L_c\)</span></td>
<td>26 mm</td>
</tr>
<tr><td>Femur</td>
<td><span class="math">\(L_{femur}\)</span> or <span class="math">\(L_f\)</span></td>
<td>45 mm</td>
</tr>
<tr><td>Tibia</td>
<td><span class="math">\(L_{tibia}\)</span> or <span class="math">\(L_t\)</span></td>
<td>63 mm</td>
</tr>
</tbody>
</table>
<div class="figure align-center">
<img alt="" src="../../../../blog/robots/pics/Robot_Leg.png" />
<p class="caption">The figure on the left is for the forward kinematics, while the figure
on the right helps show how the inverse kinematics was developed.</p>
</div>
<p>The forward kinematics will follow the Denavitâ€“Hartenberg process <a class="footnote-reference" href="#id4" id="id1">[1]</a>. The
foot position is:</p>
<div class="math">
\begin{equation*}
\begin{bmatrix}
        L_c \cos \alpha + L_f \cos \alpha \cos \beta + L_t (-\sin \beta \sin \gamma \cos \alpha + \cos \alpha \cos \alpha \cos \beta \cos \gamma) \\
        L_c \sin \alpha + L_f \sin \alpha \cos \beta + L_t (-\sin \alpha \sin \beta \sin \gamma + \sin \alpha \cos \cos \beta \cos \gamma) \\
        L_f \sin \beta + L_t (\sin \beta \cos \gamma + \sin \gamma \cos \beta)
\end{bmatrix}
\end{equation*}
</div>
</div>
<div class="section" id="inverse-kinematics">
<h3>Inverse Kinematics</h3>
<p>Often, we need to find the angles of the leg joints given a location (x,y,z) of
the foot. To calculate this, remember the leg is composed of 3 revolute joints.
The shoulder is in one plane and both the femur joint and tibia joint are in
another plane. The tote project <a class="footnote-reference" href="#id5" id="id2">[2]</a> helped with developing the inverse
kinematics, however, there were some errors in those equations.</p>
<p>So let's start with the shoulder, look down from the top, we see the x-y plane.
We can calculate the it's rotation <span class="math">\(\alpha\)</span> by using x and y of the foot
location.</p>
<div class="math">
\begin{equation*}
\alpha = atan2(y,x)
\end{equation*}
</div>
<p>Next, let's look at the plane which the next 2 joints lie in. Now we will calculate
the <span class="math">\(\beta\)</span> and <span class="math">\(\gamma\)</span> angles.</p>
<div class="math">
\begin{align*}
m = \sqrt{x^2 + y^2} \\
f = m - L_{coxa} \\
\beta_1 = atan2(f,z) \\
d = \sqrt{f^2 + z^2} \\
\beta_2 = \arccos( \frac{L_{femur}^2+d^2-L_{tibia}^2}{2 d L_{femur}} ) \\
\beta = \beta_1 + \beta_2
\gamma = \arccos( \frac{L_{femur}^2+L_{tibia}^2-d^2}{2 L_{femur} L_{tibia}} )
\end{align*}
</div>
<p>Now finally, you should notice the definition for <span class="math">\(\gamma\)</span> is different
between forward and reverse kinematics. So let's fix that ...</p>
<div class="math">
\begin{align*}
\gamma_{fk} = \gamma_{ik} - \pi \\
\beta_{fk} = \beta_{ik} - \pi/2
\end{align*}
</div>
</div>
</div>
<div class="section" id="gait">
<h2>Gait</h2>
<table border="1" class="docutils">
<colgroup>
<col width="34%" />
<col width="66%" />
</colgroup>
<tbody valign="top">
<tr><td>k</td>
<td>step</td>
</tr>
<tr><td>i</td>
<td>leg</td>
</tr>
<tr><td><span class="math">\(p_i\)</span></td>
<td>x,y,z position of leg</td>
</tr>
<tr><td><span class="math">\(\phi_{i,k}\)</span></td>
<td>gait foot position for leg i at step k</td>
</tr>
<tr><td><span class="math">\(z_i\)</span></td>
<td>height modifier of leg i</td>
</tr>
<tr><td><span class="math">\(R_z\)</span></td>
<td>rotation matrix around z axis</td>
</tr>
</tbody>
</table>
<p>Gaits for robots follows that of animals. There is a rhythmic repetitive pattern
that they use and we will exploit here. The gait is based on the work of Metal <a class="footnote-reference" href="#id6" id="id3">[3]</a>
with some differences.</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">k</th>
<th class="head">0</th>
<th class="head">1</th>
<th class="head">2</th>
<th class="head">3</th>
<th class="head">4</th>
<th class="head">5</th>
<th class="head">6</th>
<th class="head">7</th>
<th class="head">8</th>
<th class="head">9</th>
<th class="head">10</th>
<th class="head">11</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><span class="math">\(\phi_{1,k}\)</span></td>
<td>9/9</td>
<td>6/9</td>
<td>3/9</td>
<td>0/9</td>
<td>1/9</td>
<td>2/9</td>
<td>3/9</td>
<td>4/9</td>
<td>5/9</td>
<td>6/9</td>
<td>7/9</td>
<td>8/9</td>
</tr>
<tr><td><span class="math">\(z_1\)</span></td>
<td>0.1</td>
<td>0.2</td>
<td>0.2</td>
<td>0.1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>Each leg executes this pattern in the order of: 0, 2, 1, 3. This leads to a stable
tripod gait. Each leg is at a different point of this gait, denoted by an offset.
The offset of each leg is:</p>
<table border="1" class="docutils">
<colgroup>
<col width="64%" />
<col width="9%" />
<col width="9%" />
<col width="9%" />
<col width="9%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">leg</th>
<th class="head">0</th>
<th class="head">1</th>
<th class="head">2</th>
<th class="head">3</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>offset</td>
<td>0</td>
<td>6</td>
<td>3</td>
<td>9</td>
</tr>
</tbody>
</table>
<p>Thus at time 0, Leg 0 is at the beginning (k=0), Leg 1 is at k=6, etc.</p>
<p>The quadruped's linear and rotational movements are decoupled. The equation below
shows how the y axis movement is calculated, but the x axis equation is the same.
Basically, the <span class="math">\(\Delta\)</span> is the delta change in leg position from the normal
or resting leg position.</p>
<div class="math">
\begin{align*}
\delta(x,y) = linear(x,y) + rotational(x,y) \\
\Delta_{i,k} = \delta(x,y)/2 - \phi_{i,k} \delta(x,y)
\end{align*}
</div>
<p>where the i identifies the leg (<span class="math">\(i \in [0,1,2,3]\)</span>), k is the
step (<span class="math">\(k \in [0,1, \ldots 11]\)</span>) and linear/rotation are the commanded
linear or rotation movements of the robot.</p>
<p>Now each leg exists in its own leg reference frame. Each leg frame is rotated 45
degrees around the robot. The</p>
<p>The rotation part is handled by taking the normal leg position (x,y,z), rotating it about
the z axis and calculating the delta difference by subtracting off the original
position.</p>
<div class="math">
\begin{align*}
R_z (\theta)=
\begin{bmatrix}
        \cos(\theta) &amp; -\sin(\theta) &amp; 0 \\
        \sin(\theta) &amp; \cos(\theta) &amp; 0 \\
        0 &amp; 0 &amp; 1
\end{bmatrix} \\
rotational(x,y) = R_z(\theta) p_i - p_i
\end{align*}
</div>
<p>Finally, the new leg position is:</p>
<div class="math">
\begin{equation*}
p_i' = p_i + \Delta_{i,k}
\end{equation*}
</div>
</div>
<div class="section" id="lessons-learned">
<h2>Lessons Learned</h2>
<div class="section" id="servos">
<h3>Servos</h3>
<p>Toy RC servos have issues:</p>
<ul>
<li><p class="first">Every servo brand has different range of motion and pulse width timing since
there is no real standard of what pulse width is what angle. There is a loose
understanding that RC servo manufacturers shoot for. However, if they are off,
then the end user has to adjust their system.</p>
</li>
<li><p class="first">Every servo even within the same brand has a different range of motion</p>
<blockquote>
<ul class="simple">
<li>A pulse width of 1.5 msec on one servo might be 90 degrees on one servo,
but 84 deg on another and 100 on another. It is painful to account for all
servo biases across a lot of servos (if you are trying to do high accuracy
positioning)</li>
</ul>
</blockquote>
</li>
<li><p class="first">Quality is an issue too, I had one servo die instantly on me and another is
beginning to go. Also, I question if they are really meeting their torque
performance specification.</p>
<blockquote>
<ul>
<li><p class="first">The micros have very low torque, but should be enough for what I am doing,
however, they seem to struggle at times when they shouldn't.</p>
<blockquote>
<ul class="simple">
<li>Again, I bought the cheapest servos I could find.</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
</li>
</ul>
<p>Power:</p>
<ul class="simple">
<li>Try to keep your RPi on a different power bus than your motors. I had to put
a lot of capacitance in to account for large motor draws, but 1 out of a 100 times
there is a small hiccup that resets my system ... it isn't common, but annoying.</li>
</ul>
</div>
<div class="section" id="suggestions">
<h3>Suggestions</h3>
<ul>
<li><p class="first">Avoid RC servos if possible. My TG9e servos were bought for $2.15 each, but I
think I wasted a lot of time because of them.</p>
<blockquote>
<ul class="simple">
<li>Use robot servos like DYNAMIXEL AX-12 ($44 each) or XL-320 ($22 each) which are much
more advanced and <em>should</em> overcome many of the issues above (e.g.,
performance, quality, standards) I noted above. Most university level robotic
systems use them and for good reason.</li>
</ul>
</blockquote>
</li>
</ul>
</div>
</div>
<div class="section" id="references">
<h2>References</h2>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://en.wikipedia.org/wiki/Denavit%E2%80%93Hartenberg_parameters">https://en.wikipedia.org/wiki/Denavit%E2%80%93Hartenberg_parameters</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="https://tote.readthedocs.io/en/latest/ik.html">https://tote.readthedocs.io/en/latest/ik.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td>Metal, Martin, &quot;Quadrupedal walking robot, statically balanced walker,&quot;
found PDF on internet somewhere.</td></tr>
</tbody>
</table>
</div>
<script type='text/javascript'>if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "left",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>

<p align="center"><a href="#">on the top</a></p>
    </div>
</div>
<div id="footer-wrapper">
<ul class="footer">
</ul><ul class="footer">
    <li class="footer">&copy;&nbsp;2016&nbsp;Kevin J. Walchko&nbsp;::</li>
    <li class="footer"><a href="../../../..">Planet Express </a>&nbsp;::</li>
    <li class="footer"><a href="https://github.com/getpelican">pelican</a></li>
    <!-- <li class="footer"><a href="http://creativecommons.org/licenses/by-nc/3.0/deed">Content CC BY-NC</a>&nbsp;::</li> -->
    <!-- <li class="footer"><a href="http://fontawesome.io">Font Awesome <i class="fa fa-flag"></i></a></li> -->
    <!-- <li class="footer"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a></li> -->
</ul>
<span><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a></span>
</div></body>
</html>